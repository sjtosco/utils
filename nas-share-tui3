#!/bin/bash
# Manage SMB: the easy way.

CONFIG_DIR="/etc/samba/smb.conf.d"
SMB_CONF_MAIN="/etc/samba/smb.conf"
SMB_DYNAMIC_CONF="/etc/samba/smb_dynamic.conf"
BACKUP_DIR="/root/samba_backups"
EDITOR="vi"

# === Inicialización y utilidades ===

init_config() {
    mkdir -p "$CONFIG_DIR" "$BACKUP_DIR"
    grep -Fq "include = $SMB_DYNAMIC_CONF" "$SMB_CONF_MAIN" 2>/dev/null || \
        echo "include = $SMB_DYNAMIC_CONF" >> "$SMB_CONF_MAIN"
    [ -f "$SMB_DYNAMIC_CONF" ] || echo "" > "$SMB_DYNAMIC_CONF"
}

backup_dynamic() {
    cp "$SMB_DYNAMIC_CONF" "$BACKUP_DIR/smb_dynamic.conf.$(date +%Y%m%d%H%M%S)"
}

rollback_dynamic() {
    latest=$(ls -t "$BACKUP_DIR"/smb_dynamic.conf.* 2>/dev/null | head -n1)
    if [ -n "$latest" ]; then
        cp "$latest" "$SMB_DYNAMIC_CONF"
        rc-service samba restart
        echo "[+] Rollback aplicado desde $latest"
    else
        echo "[!] No hay backups para rollback."
    fi
    sleep 1
}

reload_samba() {
    echo "[*] Verificando configuración con testparm..."
    if testparm -s "$SMB_DYNAMIC_CONF" &>/dev/null; then
        rc-service samba restart
        echo "[+] Samba reiniciado OK."
    else
        echo "[!] Error de configuración. Revertiendo..."
        rollback_dynamic
    fi
    sleep 1
}

update_dynamic_smb_conf() {
    backup_dynamic
    if ls "$CONFIG_DIR"/*.conf &>/dev/null; then
        cat "$CONFIG_DIR"/*.conf > "$SMB_DYNAMIC_CONF"
    else
        echo "" > "$SMB_DYNAMIC_CONF"
    fi
}

# === Shares ===

valid_share_name() {
    [[ "$1" =~ ^[a-zA-Z0-9._-]+$ ]]
}

add_smb_share() {
    read -p "Nombre del share SMB: " share_name
    if ! valid_share_name "$share_name"; then
        echo "Nombre inválido (solo alfanuméricos, puntos, guiones, underline)."
        sleep 1
        return
    fi

    read -p "Ruta absoluta del directorio: " share_path
    if [[ ! -d "$share_path" ]]; then
        echo "La ruta no existe o no es directorio."
        sleep 1
        return
    fi

    cat <<EOF > "$CONFIG_DIR/$share_name.conf"
[$share_name]
   path = $share_path
   browseable = yes
   read only = no
   guest ok = no
   create mask = 0775
   directory mask = 2775
EOF

    update_dynamic_smb_conf
    reload_samba
    echo "[+] Share SMB '$share_name' creado."
    sleep 1
}

list_and_edit_smb() {
    local files=($(ls "$CONFIG_DIR" 2>/dev/null))
    [ ${#files[@]} -eq 0 ] && echo "No hay shares para editar." && sleep 1 && return

    echo "Selecciona share a editar:"
    select file in "${files[@]}" "Cancelar"; do
        [[ "$file" == "Cancelar" || -z "$file" ]] && break
        $EDITOR "$CONFIG_DIR/$file"
        update_dynamic_smb_conf
        reload_samba
        break
    done
}

delete_smb_share() {
    local files=($(ls "$CONFIG_DIR" 2>/dev/null))
    [ ${#files[@]} -eq 0 ] && echo "Nada que borrar." && sleep 1 && return

    select file in "${files[@]}" "Cancelar"; do
        [[ "$file" == "Cancelar" || -z "$file" ]] && break
        rm -f "$CONFIG_DIR/$file"
        update_dynamic_smb_conf
        reload_samba
        echo "[+] Share borrado."
        break
    done
    sleep 1
}

# === Usuarios Samba ===

samba_user_exists() {
    local user="$1"
    if pdbedit -L | awk -F: '{print $1}' | grep -q "^$user$"; then
        return 0
    else
        return 1
    fi
}

add_samba_user() {
    read -p "Nombre de usuario del sistema a agregar: " user
    if ! id "$user" &>/dev/null; then
        echo "Usuario del sistema no existe."
        sleep 1
        return
    fi

    if samba_user_exists "$user"; then
        echo "El usuario Samba '$user' ya existe."
        sleep 1
        return
    fi

    smbpasswd -a "$user"
    echo "[+] Usuario '$user' agregado a Samba."
    sleep 1
}

delete_samba_user() {
    read -p "Usuario Samba a eliminar: " user
    if samba_user_exists "$user"; then
        smbpasswd -x "$user"
        echo "[+] Usuario Samba '$user' eliminado."
    else
        echo "[!] El usuario Samba '$user' no existe."
    fi
    sleep 1
}

list_samba_users() {
    echo "Usuarios Samba registrados:"
    pdbedit -L
    read -p "Presiona Enter para continuar..."
}

change_samba_password() {
    read -p "Usuario para cambiar contraseña Samba: " user
    if samba_user_exists "$user"; then
        smbpasswd "$user"
        echo "[+] Contraseña del usuario '$user' actualizada."
    else
        echo "[!] El usuario Samba '$user' no existe."
    fi
    sleep 1
}

# === Menú ===

init_config
while true; do
    clear
    echo "=== SAMBA TUI (ALPINE LXC) ==="
    echo "1) Ver estado Samba"
    echo "2) Añadir share"
    echo "3) Editar share"
    echo "4) Borrar share"
    echo "--- Usuarios Samba ---"
    echo "5) Listar usuarios Samba"
    echo "6) Añadir usuario Samba"
    echo "7) Borrar usuario Samba"
    echo "8) Cambiar contraseña Samba"
    echo "9) Salir"
    read -p "Selecciona: " opt
    case $opt in
        1) rc-service samba status; read -p "Enter..." ;;
        2) add_smb_share ;;
        3) list_and_edit_smb ;;
        4) delete_smb_share ;;
        5) list_samba_users ;;
        6) add_samba_user ;;
        7) delete_samba_user ;;
        8) change_samba_password ;;
        9) exit 0 ;;
        *) echo "Opción inválida"; sleep 1 ;;
    esac
done
