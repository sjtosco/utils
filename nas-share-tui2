#!/bin/bash
# SAMBA config TUI: The easy way ;-)

CONFIG_DIR="/etc/samba/smb.conf.d"
SMB_CONF_MAIN="/etc/samba/smb.conf"
SMB_DYNAMIC_CONF="/etc/samba/smb_dynamic.conf"
BACKUP_DIR="/root/samba_backups"
CONFIG_FILE="/root/.config/nas-share-tui/config"
EDITOR="vi"  # Por defecto

# === Inicialización y Configuración ===
init_config() {
    mkdir -p "$CONFIG_DIR" "$BACKUP_DIR"
    grep -Fq "include = $SMB_DYNAMIC_CONF" "$SMB_CONF_MAIN" 2>/dev/null || \
        echo "include = $SMB_DYNAMIC_CONF" >> "$SMB_CONF_MAIN"
    [ -f "$SMB_DYNAMIC_CONF" ] || echo "" > "$SMB_DYNAMIC_CONF"
}

load_config() {
    mkdir -p "$(dirname "$CONFIG_FILE")"
    [ -f "$CONFIG_FILE" ] && source "$CONFIG_FILE"
}

change_editor() {
    echo "Selecciona editor por defecto:"
    select choice in "nano" "vi" "Cancelar"; do
        case "$choice" in
            nano|vi)
                EDITOR="$choice"
                mkdir -p "$(dirname "$CONFIG_FILE")"
                echo "EDITOR=\"$EDITOR\"" > "$CONFIG_FILE"
                echo "Editor establecido a '$EDITOR'."
                sleep 1
                break
                ;;
            "Cancelar") break ;;
            *) echo "Opción inválida." ;;
        esac
    done
}

# === Backup y rollback ===
backup_dynamic() {
    cp "$SMB_DYNAMIC_CONF" "$BACKUP_DIR/smb_dynamic.conf.$(date +%Y%m%d%H%M%S)"
}

rollback_dynamic() {
    latest=$(ls -t "$BACKUP_DIR"/smb_dynamic.conf.* 2>/dev/null | head -n1)
    if [ -n "$latest" ]; then
        cp "$latest" "$SMB_DYNAMIC_CONF"
        rc-service samba restart
        echo "[+] Rollback aplicado desde $latest"
    else
        echo "[!] No hay backups para rollback."
    fi
    sleep 1
}

reload_samba() {
    echo "[*] Verificando configuración con testparm..."
    if testparm -s "$SMB_DYNAMIC_CONF" &>/dev/null; then
        rc-service samba restart
        echo "[+] Samba reiniciado OK."
    else
        echo "[!] Error de configuración. Revertiendo..."
        rollback_dynamic
    fi
    sleep 1
}

update_dynamic_smb_conf() {
    backup_dynamic
    if ls "$CONFIG_DIR"/*.conf &>/dev/null; then
        cat "$CONFIG_DIR"/*.conf > "$SMB_DYNAMIC_CONF"
    else
        echo "" > "$SMB_DYNAMIC_CONF"
    fi
}

# === Validaciones ===
valid_share_name() {
    [[ "$1" =~ ^[a-zA-Z0-9._-]+$ ]]
}

samba_user_exists() {
    local user="$1"
    pdbedit -L | awk -F: '{print $1}' | grep -q "^$user$"
}

# === Gestión de Shares ===
add_smb_share() {
    read -p "Nombre del share SMB: " share_name
    if ! valid_share_name "$share_name"; then
        echo "Nombre inválido (solo alfanuméricos, puntos, guiones, underline)."
        sleep 1
        return
    fi

    read -p "Ruta absoluta del directorio: " share_path
    if [[ ! -d "$share_path" ]]; then
        echo "La ruta no existe o no es directorio."
        sleep 1
        return
    fi

    cat <<EOF > "$CONFIG_DIR/$share_name.conf"
[$share_name]
   path = $share_path
   browseable = yes
   writable = yes
   guest ok = no
   valid users = root
   force user = root
   force group = root
   create mask = 0664
   directory mask = 0775
EOF

    update_dynamic_smb_conf
    reload_samba
    echo "[+] Share SMB '$share_name' creado."
    sleep 1
}

list_and_edit_smb() {
    local files=($(ls "$CONFIG_DIR" 2>/dev/null))
    [ ${#files[@]} -eq 0 ] && echo "No hay shares para editar." && sleep 1 && return

    echo "Selecciona share a editar:"
    select file in "${files[@]}" "Cancelar"; do
        [[ "$file" == "Cancelar" || -z "$file" ]] && break
        $EDITOR "$CONFIG_DIR/$file"
        update_dynamic_smb_conf
        reload_samba
        break
    done
}

delete_smb_share() {
    local files=($(ls "$CONFIG_DIR" 2>/dev/null))
    [ ${#files[@]} -eq 0 ] && echo "Nada que borrar." && sleep 1 && return

    select file in "${files[@]}" "Cancelar"; do
        [[ "$file" == "Cancelar" || -z "$file" ]] && break
        rm -f "$CONFIG_DIR/$file"
        update_dynamic_smb_conf
        reload_samba
        echo "[+] Share borrado."
        break
    done
    sleep 1
}

# === Gestión de Usuarios Samba ===
add_samba_user() {
    read -p "Nombre de usuario del sistema a agregar: " user
    if ! id "$user" &>/dev/null; then
        echo "Usuario del sistema no existe."
        sleep 1
        return
    fi
    if samba_user_exists "$user"; then
        echo "El usuario Samba '$user' ya existe."
        sleep 1
        return
    fi
    smbpasswd -a "$user"
    echo "[+] Usuario '$user' agregado a Samba."
    sleep 1
}

delete_samba_user() {
    read -p "Usuario Samba a eliminar: " user
    if samba_user_exists "$user"; then
        smbpasswd -x "$user"
        echo "[+] Usuario Samba '$user' eliminado."
    else
        echo "[!] El usuario Samba '$user' no existe."
    fi
    sleep 1
}

list_samba_users() {
    echo "Usuarios Samba registrados:"
    pdbedit -L
    read -p "Presiona Enter para continuar..."
}

change_samba_password() {
    read -p "Usuario para cambiar contraseña Samba: " user
    if samba_user_exists "$user"; then
        smbpasswd "$user"
        echo "[+] Contraseña del usuario '$user' actualizada."
    else
        echo "[!] El usuario Samba '$user' no existe."
    fi
    sleep 1
}

# === Gestión de Samba (habilitar/deshabilitar) ===
enable_samba() {
    rc-update add samba
    rc-service samba start
    echo "[+] Samba habilitado y arrancado."
    sleep 1
}

disable_samba() {
    rc-service samba stop
    rc-update del samba
    echo "[+] Samba detenido y deshabilitado."
    sleep 1
}

# === Utilidades ===
show_samba_status() {
    rc-service samba status
    read -p "Presiona Enter para continuar..."
}

restart_samba() {
    rc-service samba restart
    echo "[+] Samba reiniciado."
    sleep 1
}

launch_glances() {
    command -v glances >/dev/null 2>&1 || {
        echo "Glances no está instalado. Usa: apk add py3-pip && pip install glances"
        read -rp "Presiona Enter para continuar..."
        return
    }
    echo "Presiona 'q' para salir de Glances y volver al menú."
    sleep 1
    glances
}

# === Menú principal ===
main_menu() {
    while true; do
        clear
        echo "=== NAS SMB Admin ==="
        echo "Editor por defecto: $EDITOR"
        echo
        echo "--- Shares ---"
        echo "1) Agregar share"
        echo "2) Editar share"
        echo "3) Borrar share"
        echo
        echo "--- Usuarios ---"
        echo "4) Listar usuarios"
        echo "5) Agregar usuario"
        echo "6) Borrar usuario"
        echo "7) Cambiar contraseña"
        echo
        echo "--- Utilidades ---"
        echo "8) Ver estado Samba"
        echo "9) Reiniciar Samba"
        echo "10) Habilitar Samba"
        echo "11) Deshabilitar Samba"
        echo "12) Ver estado del sistema (Glances)"
        echo "13) Cambiar editor por defecto"
        echo "14) Salir"
        read -p "Opción [1-14]: " opt
        case $opt in
            1) add_smb_share ;;
            2) list_and_edit_smb ;;
            3) delete_smb_share ;;
            4) list_samba_users ;;
            5) add_samba_user ;;
            6) delete_samba_user ;;
            7) change_samba_password ;;
            8) show_samba_status ;;
            9) restart_samba ;;
            10) enable_samba ;;
            11) disable_samba ;;
            12) launch_glances ;;
            13) change_editor ;;
            14) exit 0 ;;
            *) echo "Opción inválida" && sleep 1 ;;
        esac
    done
}

# === Ejecución principal ===
[ "$1" = "-h" ] || [ "$1" = "--help" ] && {
    echo "Uso: $(basename "$0")"
    echo "Menú interactivo para administrar SMB y usuarios Samba"
    exit 0
}

init_config
load_config
main_menu
